'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.handler = exports.builder = exports.desc = exports.command = undefined;
exports.accessTokenCreate = accessTokenCreate;

var _context = require('../../../context');

var _assertions = require('../../../utils/assertions');

var _async = require('../../../utils/async');

var _contentfulClients = require('../../../utils/contentful-clients');

var _emojis = require('../../../utils/emojis');

var _log = require('../../../utils/log');

var _normalizer = require('../../../utils/normalizer');

var _normalizer2 = _interopRequireDefault(_normalizer);

var _pagination = require('../../../utils/pagination');

var _pagination2 = _interopRequireDefault(_pagination);

var _styles = require('../../../utils/styles');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const command = exports.command = 'create';

const desc = exports.desc = 'Create a delivery access token';

const builder = exports.builder = yargs => {
  return yargs.usage('Usage: contentful accesstoken create --name \'Your token name\' --description \'Your token description\'').option('name', {
    alias: 'n',
    describe: 'Name of the Token to create',
    demandOption: true
  }).option('description', {
    alias: 'desc',
    describe: 'Description giving more detailed information about the usage of the Token'
  }).option('management-token', {
    alias: 'mt',
    describe: 'Contentful management API token',
    type: 'string'
  }).option('space-id', { alias: 's', type: 'string', describe: 'Space id' }).option('silent', {
    describe: 'Suppress command output',
    default: false
  }).epilog('Copyright 2018 Contentful, this is a BETA release');
};

async function accessTokenCreate(argv) {
  await (0, _assertions.assertLoggedIn)(argv);
  await (0, _assertions.assertSpaceIdProvided)(argv);
  const { spaceId } = await (0, _normalizer2.default)(argv);
  const { cmaToken } = await (0, _context.getContext)();

  const client = await (0, _contentfulClients.createManagementClient)({
    accessToken: argv.managementToken || cmaToken,
    feature: argv.feature || 'space-access_token-create'
  });

  const space = await client.getSpace(spaceId);
  const accessTokens = await (0, _pagination2.default)({ client: space, method: 'getApiKeys' });

  let accessToken = accessTokens.items.find(key => key.name === argv.name);

  if (accessToken) {
    if (!argv.silent) {
      (0, _log.success)(`${_emojis.successEmoji} Successfully returned already existing access token ${(0, _styles.highlightStyle)(accessToken.name)} (${(0, _styles.highlightStyle)(accessToken.accessToken)})`);
    }
    return accessToken;
  }

  accessToken = await space.createApiKey({
    name: argv.name,
    description: argv.description
  });

  if (!argv.silent) {
    (0, _log.success)(`${_emojis.successEmoji} Successfully created access token ${(0, _styles.highlightStyle)(accessToken.name)} (${(0, _styles.highlightStyle)(accessToken.accessToken)})`);
  }

  return accessToken;
}

const handler = exports.handler = (0, _async.handleAsyncError)(accessTokenCreate);